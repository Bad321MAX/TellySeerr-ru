import logging
import html
from pyrogram import filters, Client
from pyrogram.types import Message
from pyrogram.enums import ParseMode

from bot import app
from config import settings
from bot.services.http_clients import http_client, jellyfin_headers
from bot.services.database import get_linked_user
from bot.i18n import t

log = logging.getLogger(__name__)


@app.on_message(filters.command("watch", prefixes="/") & filters.private)
async def watch_stats_cmd(_: Client, m: Message):
    log.info(f"User {m.from_user.id} called /watch")

    sent_message = await m.reply(t("fetching_watch"))

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    linked_user = await get_linked_user(str(m.from_user.id))
    if not linked_user:
        await sent_message.edit(t("watch_no_link"))
        log.warning(f"No linked account for user {m.from_user.id}")
        return

    _, jellyfin_user_id, _ = linked_user[:3]
    if not jellyfin_user_id:
        await sent_message.edit(t("watch_no_userid"))
        log.warning(f"No Jellyfin user ID for user {m.from_user.id}")
        return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Jellyfin API
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    items_url = f"{settings.JELLYFIN_URL}/Users/{jellyfin_user_id}/Items"
    params = {
        "Recursive": "true",
        "IncludeItemTypes": "Movie,Episode",
        "Filters": "IsPlayed",
        "Fields": "UserData,SeriesName",
    }

    try:
        response = await http_client.get(
            items_url,
            headers=jellyfin_headers,
            params=params,
        )
        log.info(f"/watch API response: {response.status_code}")
        response.raise_for_status()
        items = response.json().get("Items", [])
    except Exception as e:
        await sent_message.edit(t("generic_network_error"))
        log.error(f"Error fetching watch stats: {e}")
        return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    watched_count = len(items)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ°Ğ¹Ñ‚Ğ»
    # (Ğ¿Ğ¾ LastPlayedDate)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    last_watched_title = t("no_last_watched")

    if items:
        items.sort(
            key=lambda x: x.get("UserData", {}).get("LastPlayedDate", ""),
            reverse=True,
        )
        item = items[0]
        title = item.get("Name", "Unknown")

        if item.get("Type") == "Episode":
            series = item.get("SeriesName")
            if series:
                title = f"{series} â€” {title}"

        last_watched_title = html.escape(title)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    username_html = html.escape(m.from_user.first_name or "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ")

    text = (
        f"ğŸ“Š <b>{username_html}'s Watch Statistics</b>\n\n"
        f"<b>ğŸ“º Total Watched Items:</b> {watched_count}\n"
        f"<b>ğŸ‘€ Last Watched:</b> {last_watched_title}\n\n"
        f"<i>ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ±ĞµĞ· user token</i>"
    )

    await sent_message.edit(text, parse_mode=ParseMode.HTML)
